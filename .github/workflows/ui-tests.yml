name: UI Tests

on:
  workflow_run:
    workflows: ["Test"]
    types:
      - completed
  workflow_dispatch:  # Allow manual trigger

jobs:
  test:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    # Only run if the test workflow succeeded or if manually triggered
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      if: github.event_name != 'workflow_dispatch'
      with:
        name: build-ubuntu-latest
        path: .

    - name: Build application (manual trigger)
      if: github.event_name == 'workflow_dispatch'
      run: |
        # Install Rust for manual runs
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source $HOME/.cargo/env
        cargo build
        npm run build-css

    - name: Make binary executable
      run: |
        chmod +x target/debug/cook || true
        ls -la target/debug/cook || echo "Binary not found, will be built by Playwright"

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium

    - name: Run Playwright tests
      run: npm test
      continue-on-error: false

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

    - name: Upload test videos
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-videos
        path: test-results/
        retention-days: 7